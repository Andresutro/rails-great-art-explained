<%# Post %>

<div class="artpost-container">
  <%# Policies %>
  <div class="w-100 mb-3 justify-content-center nav-item d-flex gap-3 align-items-center">
    <%# <%= link_to "Volver", arts_path, class: 'text-decoration-none text-black' %>
    <% if policy(@art).edit? %>
      <%= link_to "Editar el arte", edit_art_path(@art), class: 'text-underline-black text-black text-decoration-none' %> |
    <% end %>
    <% if policy(@art).destroy? %>
      <%= button_to "Borrar el arte", @art, method: :delete, class: 'text-underline-black text-black border-0 bg-transparent' %>
    <% end %>

    <%# <%= turbo_stream_from [@art, :view] %>

    <% @art.explanations.each do |explanation| %>
      <%= render 'explanations/explanation', explanation: explanation %>
    <% end %>
  </div>

  <%# Titulo + Tags %>
  <div class="w-100 justify-content-center text-container text-center">

    <%# Titulo %>
    <h2 class="w-100 font-italic mt-auto text-decoration-none text-center text-black"><%= @art.title %></h2>

    <%# Avatar + Nombre %>
    <div class="w-100 justify-content-center artist-info">
      <% artista = User.find(@art.user_id) %>
      <div href="#" class="avatar" style="background-image: url(<%= cl_image_path(artista.photo.key)%>); background-size: cover; background-position: center;"></div>
      <div class="mt-2 artist-description">
        <h5 href="#" class="text-black" style="line-height: 0;">
          <%= artista.email %>
        </h5>
      </div>
    </div>

    <%# Likes and Comments %>
    <%= render "shared/likes_comments" %>
  </div>

  <%# Imagen %>
  <div class="mt-3 big-image" style="background-image: url(<%= cl_image_path(@art.photo.key)  %>)"></div>

  <%# Tags %>
  <div class="mt-3 d-flex gap-5">
    <div class="d-flex gap-2">
      <h6 class='button'><%= @art.category %></h6>
      <h6 class='button'><%= @art.year %></h6>
    </div>
  </div>

  <%# Texto %>
  <div class="mb-5 row">
    <div class="col-lg-6">
      <p class="lh-xl"><%= simple_format(@art.description.split(' ').slice(0, @art.description.split(' ').length / 2).join(' ')) %></p>
    </div>
    <div class="col-lg-6">
      <p class="lh-xl"><%= simple_format(@art.description.split(' ').slice(@art.description.split(' ').length / 2, @art.description.split(' ').length).join(' ')) %></p>
    </div>
  </div>
</div>

<%# Policy %>
<%# <% if @art.appreciations.count == 0  %>
  <%# <small><em class="text-muted">Be the first one to appreciate this list</em></small> %>
<%# <% else %>
  <%# <% @art.appreciations.each do |appreciation| %>
    <%# <div> %>
      <%# <small><%= appreciation.user.email <em class="text-muted"><%= distance_of_time_in_words_to_now(appreciation.created_at) ago</em></small> %>
      <%# <p><%= appreciation.content</p> %>
      <%# # <% appreciation.like_appreciations.count Likes %>
      <%# <% like_appreciation = current_user.like_appreciations.find_by(appreciation: appreciation)
      <%# <% if like_appreciation.nil? %>

      <%# <form action='/like_appreciations' method='post'> %>
        <%# <input type="hidden"  name='authenticity_token' value="<%= form_authenticity_token %>
        <%# <input type="hidden"  name='like_appreciation[appreciation_id]' value="<%= appreciation.id %>
        <%# <input type="submit" value="Like"> %>
      <%# </form> %>
      <%# <% else %>
      <%# unlike %>
      <%# <form action='<%= like_appreciation_path(like_appreciation)' method='post'>  %>
        <%# <input type="hidden"  name='authenticity_token' value="<%= form_authenticity_token">  %>
        <%# <input type="hidden"  name='_method' value="DELETE"> %>
        <%# <input type="submit" value="Unlike"> %>
      <%# </form> %>


      <%# <% end %>
    <%# </div> %>
    <%# <hr> %>
  <%# <% end %>
<%# <% end %>

<%# Divider %>
<%# <div class="opacity-50" style="background-color: #272A2D; height: 1px; width: 100%;"></div> %>

<div class="mt-0 bg-light artpost-container">
  <%# Escribe tu comentario %>
  <% if current_user != @art.user %>
    <div class="w-100">
      <div class="d-flex flex-start gap-4 align-items-top mb-5">
        <%# Avatar del Usuario %>
        <div class="avatar" style="background-image: url('<%= current_user ? cl_image_path(current_user.photo.key) : 'https://simulacionymedicina.es/wp-content/uploads/2015/11/default-avatar-300x300-1.jpg' %>'); background-size: cover; background-position: center; border-radius: 100%;""></div>

        <%# Field %>
        <div class="mt-1 w-100">
          <%= simple_form_for [@art, @appreciation] do |f| %>

            <%= f.input :content, placeholder: "Escribe tu comentario...", label: false, class: "w-100", input_html: { style: 'background-color: white; height: 10rem;' } %>
            <%= f.submit "Publicar", class: "btn btn-dark btn-md" %>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <%# Mensaje si no hay/hay comentarios %>
  <div id='comment-box' class="w-100 h-100">
    <% if @art.appreciations.any? %>
      <% @art.appreciations.each do |appreciation| %>
        <div class="w-100">
          <%= render 'appreciations/appreciation', appreciation: appreciation %>
          <%= pluralize(appreciation.like_appreciations.count, 'Like') %>
          <% like_appreciation = current_user&.like_appreciations&.find_by(appreciation: appreciation) %>
          <% if like_appreciation.nil? %>
            <%= form_with url: like_appreciations_path, method: :post, remote: true do %>
              <%= hidden_field_tag 'like_appreciation[appreciation_id]', appreciation.id %>
              <%= submit_tag 'Like', class: 'fas fa-xl fa-heart text-secondary', id: 'heart-icon' %>
            <% end %>
          <% else %>
            <%= form_with url: like_appreciation_path(like_appreciation), method: :delete do %>
              <%= submit_tag 'Unlike', class: 'btn btn-danger' %>
            <% end %>
          <% end %>
        </div>
        <hr>
      <% end %>
    <% else %>
      <p class="text-secondary">Se el primero en dejar tu comentario</p>
    <% end %>
  </div>

</div>

<%# Donaciones %>
<div class="artpost-container w-100 h-100">
  <% if current_user != @art.user %>
    <%= form_with(model: Donation.new, url: user_donations_path(@art.user)) do |form| %>
      <%= form.hidden_field :art_id, value: @art.id %>
      <div class="field">
        <%= form.label :amount %>
        <%= form.number_field :amount %>
      </div>
      <%= form.submit 'Donate' %>
    <% end %>
  <% end %>
</div>


<%# Scripts %>

<script>
<% if current_user != @art.user %>
  <%= form_with(model: Donation.new, url: user_donations_path(@art.user)) do |form| %>
    <%= form.hidden_field :art_id, value: @art.id %>
    <div class="field">
      <%= form.label :amount %>
      <%= form.number_field :amount %>
    </div>
      </div>
    <div class="field">
      <%= form.label :message %>
      <%= form.text_area :message %>
    </div>
    <%= form.submit 'Donate' %>
  <% end %>
<% end %>


<%= link_to "Donaciones Recibidas", received_user_donations_path(@user) %>
<%= link_to "Donaciones Realizadas", made_user_donations_path(current_user) %>


  <script>

  document.addEventListener('DOMContentLoaded', function() {
    var imageContainer = document.getElementById('imageContainer');
    var pointer = document.getElementById('pointer');

    imageContainer.addEventListener('click', function(event) {
      var x = event.offsetX;
      var y = event.offsetY;

      pointer.style.top = (y - 10) + 'px';
      pointer.style.left = (x - 10) + 'px';
      pointer.style.display = 'block';
    });
  });
</script>

<script>
  $(document).ready(function() {
    $('#appreciation-form').on('ajax:success', function() {
      $('html, body').animate({ scrollTop: $('#comment-box').offset().top }, 'slow');
    });
  });
</script>

