<%# Post %>

<div class="artpost-container">
  <%# Policies %>
  <div class="w-100 mb-3 justify-content-center nav-item d-flex gap-3 align-items-center">
    <% if policy(@art).edit? %>
      <%= link_to "Editar el arte", edit_art_path(@art), class: 'link text-secondary text-decoration-none' %>
      <span class="text-secondary">|</span>
    <% end %>
    <% if policy(@art).destroy? %>
      <%= button_to "Borrar el arte", @art, method: :delete, class: 'text-secondary border-0 bg-transparent' %>
    <% end %>

    <%# <%= turbo_stream_from [@art, :view]  %>
    <% @art.explanations.each do |explanation| %>
      <%= render 'explanations/explanation', explanation: explanation %>
    <% end %>
  </div>

  <%# Titulo + Tags %>
  <div class="w-100 justify-content-center text-container text-center">

    <%# Titulo %>
    <h2 class="w-100 font-italic mt-auto text-decoration-none text-center text-black"><%= @art.title %></h2>

    <%# Avatar + Nombre %>
    <div class="w-100 justify-content-center artist-info">
      <% artista = User.find(@art.user_id) %>
      <div href="#" class="avatar" style="background-image: url(<%= cl_image_path(artista.photo.key)%>); background-size: cover; background-position: center;"></div>
      <div class="mt-2 artist-description">
        <h5 href="#" class="text-black" style="line-height: 0;">
          <%= artista.email %>
        </h5>
      </div>
    </div>

    <%# Likes and Comments %>
    <div class="w-100 justify-content-center">
      <%= render "shared/likes_comments" %>
    </div>
  </div>

  <%# Imagen %>
  <div class="mt-3 big-image" style="background-image: url(<%= cl_image_path(@art.photo.key)  %>)"></div>

  <%# Tags %>
  <div class="mt-3 d-flex gap-5">
    <div class="d-flex gap-2">
      <h6 class='button'><%= @art.category %></h6>
      <h6 class='button'><%= @art.year %></h6>
    </div>
  </div>

  <%# Texto %>
  <div class="mb-5 row">
    <div class="col-lg-6">
      <p class="lh-xl"><%= simple_format(@art.description.split(' ').slice(0, @art.description.split(' ').length / 2).join(' ')) %></p>
    </div>
    <div class="col-lg-6">
      <p class="lh-xl"><%= simple_format(@art.description.split(' ').slice(@art.description.split(' ').length / 2, @art.description.split(' ').length).join(' ')) %></p>
    </div>
  </div>

  <%# Anadir descripcion %>
  <div class="w-100 my-5">
    <% if current_user == @art.user %>
      <%= simple_form_for [@art, @explanation] do |f| %>
        <%= f.input :description, placeholder: "Add a description here...", label: false, class: "w-100", input_html: { style: 'background-color: white; height: 10rem;' } %>
        <%= f.input :image, as: :file, required: true, label: false, placeholder: "Image", id: "upload_widget", class: "cloudinary-button", input_html: { style: 'background-color: white;' } %>
        <%= f.submit "Submit", class: "mt-4 btn btn-dark" %>
      <% end %>
    <% end %>
  </div>

</div>


<%# Comentarios %>
<div class="mt-0 bg-light artpost-container">
  <%# Escribe tu comentario %>
  <% if current_user != @art.user %>
    <div class="w-100">
      <div class="d-flex flex-start gap-4 align-items-top mb-5">
        <%# Avatar del Usuario %>
        <div class="avatar" style="background-image: url('<%= current_user ? cl_image_path(current_user.photo.key) : 'https://simulacionymedicina.es/wp-content/uploads/2015/11/default-avatar-300x300-1.jpg' %>'); background-size: cover; background-position: center; border-radius: 100%;""></div>

        <%# Field %>
        <div class="mt-1 w-100">
          <%= simple_form_for [@art, @appreciation] do |f| %>
            <%= f.input :content, placeholder: "Escribe tu comentario...", label: false, class: "w-100", input_html: { style: 'background-color: white; height: 10rem;' } %>
            <%= f.submit "Publicar", class: "btn btn-dark btn-md" %>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <%# Mensaje si no hay/hay comentarios %>
  <div id='comment-box' class="w-100 h-100">
    <% if @art.appreciations.any? %>
      <% @art.appreciations.each do |appreciation| %>
        <div class="w-100">
          <%= render 'appreciations/appreciation', appreciation: appreciation %>
        </div>
        <hr>
      <% end %>
    <% elsif @art.appreciations.empty? && current_user == @art.user %>
      <p class="text-secondary">TodavÃ­a no tienes comentarios ðŸ¥²</p>
    <% else %>
      <p class="text-secondary">Se el primero en dejar tu comentario ðŸ¥‡</p>
    <% end %>
  </div>


  <%# Donaciones %>
  <div class="artpost-container w-100 h-100">
    <% if current_user != @art.user %>
      <%= form_with(model: Donation.new, url: user_donations_path(@art.user)) do |form| %>
        <%= form.hidden_field :art_id, value: @art.id %>
        <div class="field">
          <%= form.label :amount %>
          <%= form.number_field :amount %>
        </div>
        <%= form.submit 'Donate' %>
      <% end %>
    <% end %>
  </div>
</div>

<%# Scripts %>

<% if current_user != @art.user %>
  <%= form_with(model: Donation.new, url: user_donations_path(@art.user)) do |form| %>
    <%= form.hidden_field :art_id, value: @art.id %>
    <div class="field">
      <%= form.label :amount %>
      <%= form.number_field :amount %>
    </div>
      </div>
    <div class="field">
      <%= form.label :message %>
      <%= form.text_area :message %>
    </div>
    <%= form.submit 'Donate' %>
  <% end %>
<% end %>

<% if user_signed_in?  %>
  <% if current_user == @art.user %>
    <%= link_to "Donaciones Recibidas", received_user_donations_path(@user) %>
  <% else %>
    <%= link_to "Donaciones Realizadas", made_user_donations_path(current_user) %>
  <% end %>
<% else %>
  <p>Para ver tus donaciones debes iniciar sesiÃ³n</p>
<% end %>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var imageContainer = document.getElementById('imageContainer');
    var pointer = document.getElementById('pointer');

    imageContainer.addEventListener('click', function(event) {
      var x = event.offsetX;
      var y = event.offsetY;

      pointer.style.top = (y - 10) + 'px';
      pointer.style.left = (x - 10) + 'px';
      pointer.style.display = 'block';
    });
  });
</script>

<script>
  $(document).ready(function() {
    $('#appreciation-form').on('ajax:success', function() {
      $('html, body').animate({ scrollTop: $('#comment-box').offset().top }, 'slow');
    });
  });
</script>

<div class="w-100 m-4">
  <div class="d-flex gap-5">
    <%= render "shared/artcard", art: @art %>
    <%= render "shared/artcard", art: @art %>
    <%= render "shared/artcard", art: @art %>
    <%= render "shared/artcard", art: @art %>
  </div>
</div>
